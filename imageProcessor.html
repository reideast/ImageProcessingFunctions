<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>07 image proc</title>
    <style>
        td {
            vertical-align: top;
        }

        .matrix {
            border-spacing: 0;
            border-collapse: collapse;
        }
        .matrix tr, .matrix td, .matrix input {
            margin: 0;
            padding: 0;
        }
        .matrix td {
            border: 1px solid #555;
        }
        .matrix input {
            border: 0;
            text-align: center;
            width: 24px;
            height: 24px;
        }
        /* .matrix tr:not(:last-child) td {
            border-bottom: 1px solid;
        }
        .matrix td:not(:last-child) {
            border-right: 1px solid;
        } */
    </style>
</head>
<body>
<table>
    <tr>
        <td>
            <input type="file" id="filename">
            <button id="reloadButton" style="display: none;">[load]</button>
            <button id="loadDefaultImageButton" style="display: inline-block;">[load]</button>
        </td>
    </tr>
    <tr>
        <td id="undoBufferOperations">
            <button id="undoButton" style="display: inline-block">Undo</button>
            <button id="redoButton" style="display: inline-block">Redo</button>
            <span id="lastOp"></span>
        </td>
    </tr>
    <tr>
        <td id="canvasArea">
            <canvas id="imgCanvas" style="border: 6px solid #555" width="500" height="500"></canvas>
        </td>
    </tr>
    <tr>
        <td class="opContainer" id="processImageOperations">
            <button onclick="noBlue()">No Blue</button>
            <button onclick="greyscale()">Greyscale</button>
            <button onclick="invert()">Invert</button>
            <input id="threshold" type="text" size="3" value="127">
            <button onclick="threshold(parseInt(document.getElementById('threshold').value))">Threshold</button>
        </td>
    </tr>
    <tr>
        <td class="opContainer" id="convolutionOperations">
            <table>
                <tr>
                    <td>
                        <button onclick="convolutionThree()">Apply 3x3</button>
                    </td>
                    <td>
                        <button onclick="convolutionFive()">Apply 5x5</button>
                    </td>
                </tr>
                <tr>
                    <td>
                        <table class="matrix" id="convolutionMatrix3x3">
                            <!--tr*3>td*3>input[type=text size=1].convThree#convThree$-->
                            <tr>
                                <td><input type="text" class="convThree" id="convThree00"></td>
                                <td><input type="text" class="convThree" id="convThree01"></td>
                                <td><input type="text" class="convThree" id="convThree02"></td>
                            </tr>
                            <tr>
                                <td><input type="text" class="convThree" id="convThree03"></td>
                                <td><input type="text" class="convThree" id="convThree04"></td>
                                <td><input type="text" class="convThree" id="convThree05"></td>
                            </tr>
                            <tr>
                                <td><input type="text" class="convThree" id="convThree06"></td>
                                <td><input type="text" class="convThree" id="convThree07"></td>
                                <td><input type="text" class="convThree" id="convThree08"></td>
                            </tr>
                        </table>
                    </td>
                    <td>
                        <table class="matrix" id="convolutionMatrix5x5">
                            <tr>
                                <td><input type="text" class="convFive" id="convFive00"></td>
                                <td><input type="text" class="convFive" id="convFive01"></td>
                                <td><input type="text" class="convFive" id="convFive02"></td>
                                <td><input type="text" class="convFive" id="convFive03"></td>
                                <td><input type="text" class="convFive" id="convFive04"></td>
                            </tr>
                            <tr>
                                <td><input type="text" class="convFive" id="convFive05"></td>
                                <td><input type="text" class="convFive" id="convFive06"></td>
                                <td><input type="text" class="convFive" id="convFive07"></td>
                                <td><input type="text" class="convFive" id="convFive08"></td>
                                <td><input type="text" class="convFive" id="convFive09"></td>
                            </tr>
                            <tr>
                                <td><input type="text" class="convFive" id="convFive10"></td>
                                <td><input type="text" class="convFive" id="convFive11"></td>
                                <td><input type="text" class="convFive" id="convFive12"></td>
                                <td><input type="text" class="convFive" id="convFive13"></td>
                                <td><input type="text" class="convFive" id="convFive14"></td>
                            </tr>
                            <tr>
                                <td><input type="text" class="convFive" id="convFive15"></td>
                                <td><input type="text" class="convFive" id="convFive16"></td>
                                <td><input type="text" class="convFive" id="convFive17"></td>
                                <td><input type="text" class="convFive" id="convFive18"></td>
                                <td><input type="text" class="convFive" id="convFive19"></td>
                            </tr>
                            <tr>
                                <td><input type="text" class="convFive" id="convFive20"></td>
                                <td><input type="text" class="convFive" id="convFive21"></td>
                                <td><input type="text" class="convFive" id="convFive22"></td>
                                <td><input type="text" class="convFive" id="convFive23"></td>
                                <td><input type="text" class="convFive" id="convFive24"></td>
                            </tr>
                        </table>
                    </td>
                </tr>
            </table>
        </td>
    </tr>
</table>

<script>
    // **************************************************************************
    // Globals
    // **************************************************************************

    const canvas = document.getElementById('imgCanvas');
    const ctx = canvas.getContext('2d');
    let width, height;

</script>
<script src="functionsLoadImage.js"></script>
<script src="functionsUndoBuffer.js"></script>
<script>
    // **************************************************************************
    // Image Processing Functions
    // **************************************************************************

    function get() {
        if (isImageLoaded) {
            return ctx.getImageData(0, 0, width, height);
        } else {
            console.error('Image not loaded yet');
            throw 'Image not loaded yet';  // Kills calling function
        }
    }

    function loopEachPixel(imgData, pixelProc, callback) {
        for (let y = 0; y < imgData.height; ++y) {
            for (let x = 0; x < imgData.width; ++x) {
                let i = (y * imgData.width + x) * 4;
                pixelProc(i, x, y);
            }
        }
        callback();
    }

    function  loopKernel(kernelSize, imgData, beforeEachKernel, kernelPixelProc, afterEachKernel, callback) {
        let kernelBorderSize = Math.floor(kernelSize / 2);
        for (let y = kernelBorderSize; y < imgData.height - kernelBorderSize; ++y) {
            for (let x = kernelBorderSize; x < imgData.width - kernelBorderSize; ++x) {
                beforeEachKernel();
                for (let yy = -kernelBorderSize; yy <= kernelBorderSize; ++yy) {
                    for (let xx = -kernelBorderSize; xx <= kernelBorderSize; ++xx) {
                        let i = ((y + yy) * imgData.width + (x + xx)) * 4;
                        let kernelCellIndex = ((yy + kernelBorderSize) * kernelSize) + (xx + kernelBorderSize);
                        kernelPixelProc(i, kernelCellIndex);
                    }
                }
                let kernelCenterIndex = ((y * imgData.width) + x) * 4;
                afterEachKernel(kernelCenterIndex);
            }
        }
        callback();
    }

    function noBlue() {
        const imgData = get();
        loopEachPixel(imgData, (i) => {
            imgData.data[i + 2] = 0;
        }, () => {
            ctx.putImageData(imgData, 0, 0);
            saveOp('Remove Blue');
        });
    }

    function greyscale() {
        const imgData = get();
        greyscaleProcessor(imgData, (greyscaleImageData) => {
            ctx.putImageData(greyscaleImageData, 0, 0);
            saveOp('Greyscale');
        });
    }

    function greyscaleProcessor(imgData, callback) {
        loopEachPixel(imgData, (i) => {
            const avgRGB = (imgData.data[i + 0] + imgData.data[i + 1] + imgData.data[i + 2]) / 3;
            imgData.data[i + 0] = imgData.data[i + 1] = imgData.data[i + 2] = avgRGB;
        }, () => callback(imgData));
    }

    function threshold(level) {
        const imgData = get();
        // TODO: Should threshold ALWAYS greyscale first? Shouldn't the user get to specify?
        greyscaleProcessor(imgData, (greyscaleImageData) => {
            // TODO: to avoid callback chaining, convert everything to promises, or maybe async
            thresholdProcessor(level, greyscaleImageData, (thresholdImageData) => {
                ctx.putImageData(thresholdImageData, 0, 0);
                saveOp('Threshold ' + level);
            });
        });
    }

    function thresholdProcessor(level, imgData, callback) {
        loopEachPixel(imgData, (i) => {
            if (imgData.data[i + 0] >= level) {
                imgData.data[i + 0] = imgData.data[i + 1] = imgData.data[i + 2] = 255;
            } else {
                imgData.data[i + 0] = imgData.data[i + 1] = imgData.data[i + 2] = 0;
            }
        }, () => callback(imgData));
    }

    function invert() {
        const imgData = get();
        invertProcessor(imgData, (invertedData) => {
            ctx.putImageData(invertedData, 0, 0);
            saveOp('Invert');
        });
    }

    function invertProcessor(imgData, callback) {
        loopEachPixel(imgData, (i) => {
            imgData.data[i + 0] = 255 - imgData.data[i + 0];
            imgData.data[i + 1] = 255 - imgData.data[i + 1];
            imgData.data[i + 2] = 255 - imgData.data[i + 2];
        }, () => callback(imgData));
    }

    function convolutionThree() {
        let kernel = readConvolutionMatrixArray("convThree");
        console.log(kernel);
        convolutionProcessor(3, kernel, get(), (processedImageData, wasModified) => {
            ctx.putImageData(processedImageData, 0, 0);
            saveOp("Convolution 3x3");
            console.log("Was modified? " + wasModified);
        })
    }

    function convolutionFive() {
        let kernel = readConvolutionMatrixArray("convFive");
        console.log(kernel);
        convolutionProcessor(5, kernel, get(), (processedImageData, wasModified) => {
            ctx.putImageData(processedImageData, 0, 0);
            saveOp("Convolution 5x5");
            console.log("Was modified? " + wasModified);
        })
    }

    function convolutionProcessor(convolutionSize, kernel, imgData, callback) {
        let anyModified = false;
        let newImageData = new ImageData(imgData.width, imgData.height);
        for (let i = 0; i < imgData.data.length; ++i) {
            newImageData.data[i] = imgData.data[i];  // Clone
        }

        let redSum, greenSum, blueSum;
        loopKernel(convolutionSize, imgData, () => {
            redSum = blueSum = greenSum = 0.0;
        }, (i, kernelCellIndex) => {
            redSum += imgData.data[i + 0] * kernel[kernelCellIndex];
            greenSum += imgData.data[i + 1] * kernel[kernelCellIndex];
            blueSum += imgData.data[i + 2] * kernel[kernelCellIndex];
        }, (centerIndex) => {
            newImageData.data[centerIndex + 0] = parseInt(redSum);
            newImageData.data[centerIndex + 1] = parseInt(greenSum);
            newImageData.data[centerIndex + 2] = parseInt(blueSum);
            if (imgData.data[centerIndex + 0] !== newImageData.data[centerIndex + 0]
                || imgData.data[centerIndex + 1] !== newImageData.data[centerIndex + 1]
                || imgData.data[centerIndex + 2] !== newImageData.data[centerIndex + 2]) {
                anyModified = true;
            }
        }, () => {
            callback(newImageData, anyModified);
        });
    }

    function readConvolutionMatrixArray(inputElemClass) {
        const inputs = document.getElementsByClassName(inputElemClass);
        let kernel = [];
        let num, value, divPos;
        for (let i = 0; i < inputs.length; ++i) {
            value = inputs[i].value;
            if ((divPos = value.indexOf("/")) !== -1) {
                // Process fractions like "1/9"
                num = parseFloat(value.slice(0, divPos)) / parseFloat(value.slice(divPos + 1));
            } else {
                num = parseFloat(value);
            }
            if (Number.isNaN(num)) {
                throw "Value for convolution '" + value + "' could not be parsed as a number";
            }
            kernel.push(num);
        }
        return kernel;
    }

    function autoInputMatrix(...matrixCells) {
        let matrixTextBoxes;
        switch (matrixCells.length) {
            case 9:
                matrixTextBoxes = document.getElementsByClassName("convThree");
                break;
            case 25:
                matrixTextBoxes = document.getElementsByClassName("convFive");
                break;
            default:
                throw 'Wrong number of matrix cells to put into text boxes' + matrixCells.length;
        }

        for (let i = 0; i < matrixTextBoxes.length; ++i) {
            matrixTextBoxes[i].value = matrixCells[i].toString();
        }
    }

</script>
</body>
</html>
